<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Pi Stream</title>
    <script type="text/javascript" src="https://cdn.pydata.org/bokeh/release/bokeh-2.1.1.min.js"></script>
    <script type="text/javascript">Bokeh.set_log_level("info");</script>
</head>

<body>
<div class="bk-root" id="streamplot"></div>

<script type="text/javascript">
    function get_plot() {
        var anHttpRequest = new XMLHttpRequest();
        anHttpRequest.onreadystatechange = function() {
            if (anHttpRequest.readyState == 4 && anHttpRequest.status == 200)
                embed_plot(anHttpRequest.responseText);  // once data is received, embed the plot
        }
        url = window.location.pathname
        queries = window.location.search
        anHttpRequest.open("GET", url+'/plot'+queries, true);
        anHttpRequest.send(null);   // send GET request for plot JSON
        console.log('sent request: '+url+'/plot'+queries)
    }

    function embed_plot(text) {
        json = JSON.parse(text)
        window.Bokeh.embed.embed_item(json, 'streamplot');  // embed received JSON into div with id='streamplot'
        console.log("Embedded initial plot")
    }

    function check_bokeh() {
        if (window.Bokeh !== undefined) {
            get_plot();
        } else {
            attempts = 0;
        timer = setInterval(attempt_load, 10, attempts)
        }
    }

    function attempt_load(attempts) {
        console.log("Failed to load - trying again ("+attempts+")")
        if (window.Bokeh !== undefined) {
            clearInterval(timer);
            get_plot();
        } else {
            attempts++;
            if (attempts > 100) {
                clearInterval(timer);
                console.log("Bokeh: ERROR: Unable to run BokehJS code because BokehJS library is missing");
            }
        }
    }

    if (document.readyState != "loading") Bokeh.safely(check_bokeh);
    else document.addEventListener("DOMContentLoaded", Bokeh.safely(check_bokeh));

</script>

</body>
</html>