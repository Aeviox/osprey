{% extends 'streams/stream_base.html' %}
{% import 'cdn.html' as cdn %}

{% block head %}
    {{ cdn.jquery() }}
    {{ cdn.socketio() }}
    <script src="/js/jmuxer.min.js"></script>
{% endblock %}

{% block content %}
<div class="stream_time"></div>
<div id="streamtage">
    <video controls autoplay muted id="stream" onplay="skip()"></video>
    <script>
        // original width and height sent from stream
        var stream_width = {{info['Raw']['width']}};
        var stream_height = {{info['Raw']['height']}};
        var ratio = stream_width/stream_height
        var height = 600; // desired height in browser
        var width = Math.round(ratio*height)  // width to maintain aspect ratio

        var vid = document.getElementById("stream");
        vid.setAttribute("width", width);
        vid.setAttribute("height", height);

        $(document).ready(function() {
            var jmuxer = new JMuxer({
                node: 'stream',
                mode: 'video',
                flushingTime: 0,
                fps: {{info['Raw']['framerate']}},
                debug: false
            });

            var vid = document.getElementById("stream");
            vid.playbackRate = 1.1;  // catch up to current position if fall behind
            skip = function() {  // called onplay to skip to live stream
                vid.currentTime = Math.floor(vid.duration);
            }

            var id = "{{info['Raw']['id']}}";

            // socketio for receiving video stream
            var video_socket = io('/video_stream');

            video_socket.on('connect', function() {
                console.log("Video streaming socketIO connected to server");
                console.log(id);
                video_socket.emit('start', id);
            });

            video_socket.on('data', (frame) => {
                // feed received frame data into jmuxer
                jmuxer.feed({video: new Uint8Array(frame)});
            });

            // socketio namespace for regular server communication
            var server_socket = io('/browser')

            // request time update every second
            setInterval(function() {
                params = new URLSearchParams(document.location.search);
                server_socket.emit('stream_time', params.get('group'));
            }, 1000);

            server_socket.on('stream_time', function(data) {
                $("div.stream_time").html(data);
            });
        });
    </script>
</div>
{% endblock %}